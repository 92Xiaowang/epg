# 工作流名称：生成电子节目指南（EPG）
name: Generate epg

# 权限设置：允许写入仓库内容（用于创建Release等操作）
permissions:
  contents: write

# 触发条件：支持手动触发和定时触发
on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    # 每6小时执行一次（UTC时间0,6,12,18点，对应北京时间8,14,20,2点）
    - cron: '0 */6 * * *'

# 定义作业
jobs:
  generate-epg:
    name: 生成并发布EPG
    runs-on: ubuntu-latest
    
    # 定义环境变量，使用英文命名避免潜在问题
    env:
      TZ: Asia/Shanghai  # 设置时区为北京时间
      INPUT_FILE: "e.xml"
      OUTPUT_FILE: "t.xml"
      COMPRESSED_FILE: "t.xml.gz"
      OUTPUT_DIR: "epg"
      SOURCE_URL: "http://epg.51zmt.top:8000/e1.xml"
      DATE_RANGE_DAYS: 7  # 保留的总天数（前5天+今天+明天=7天）
      DAYS_BEFORE: 5  # 往前保留的天数

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0  # 获取完整历史，便于标签操作

      - name: 配置运行环境
        run: |
          # 安装必要的工具
          echo "正在安装必要工具..."
          sudo apt-get update
          sudo apt-get install -y xmlstarlet gzip
          
          # 验证工具安装
          if ! command -v xmlstarlet >/dev/null 2>&1; then
            echo "错误：xmlstarlet安装失败"
            exit 1
          fi
          
          echo "环境配置完成"
          echo "xmlstarlet版本：$(xmlstarlet --version | head -1)"

      - name: 下载原始EPG文件
        run: |
          echo "正在从以下地址下载EPG：${{ env.SOURCE_URL }}"
          
          # 使用重试机制下载文件
          curl -fL --retry 3 --retry-delay 5 -o "${{ env.INPUT_FILE }}" "${{ env.SOURCE_URL }}"
          
          # 验证文件
          if [ ! -s "${{ env.INPUT_FILE }}" ]; then
            echo "错误：下载失败或文件为空"
            exit 1
          fi
          
          # 检查是否为有效的XML
          if ! xmlstarlet val "${{ env.INPUT_FILE }}" >/dev/null 2>&1; then
            echo "错误：下载的文件不是有效的XML格式"
            exit 1
          fi
          
          echo "下载成功，文件大小：$(du -h ${{ env.INPUT_FILE }} | cut -f1)"

      - name: 处理XML并筛选节目
        run: |
          # 获取日期范围
          TODAY=$(date +'%Y%m%d')
          TOMORROW=$(date -d '+1 day' +'%Y%m%d')
          START_DATE=$(date -d "-${{ env.DAYS_BEFORE }} days" +'%Y%m%d')
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          echo "=========================================="
          echo "日期范围：$START_DATE 至 $TOMORROW"
          echo "当前北京时间：$CURRENT_TIME"
          echo "=========================================="
          
          # 构建日期筛选条件
          DATE_FILTER=""
          for i in $(seq 0 $((env.DATE_RANGE_DAYS - 1))); do
            DATE=$(date -d "$START_DATE +${i} days" +'%Y%m%d')
            if [ -z "$DATE_FILTER" ]; then
              DATE_FILTER="contains(@start, '$DATE')"
            else
              DATE_FILTER="$DATE_FILTER or contains(@start, '$DATE')"
            fi
          done
          
          echo "日期筛选条件：$DATE_FILTER"
          
          # 第一步：清理和更新XML元数据
          echo "正在清理XML元数据..."
          xmlstarlet ed \
            -d "//desc" \
            -d "//tv/@*[name() != 'generator-info-name']" \
            -u "//tv/@generator-info-name" -v "mrwang" \
            -u "//tv/@date" -v "$CURRENT_TIME" \
            "${{ env.INPUT_FILE }}" > "temp_step1.xml"
          
          # 第二步：按日期筛选节目
          echo "正在按日期范围筛选节目..."
          xmlstarlet ed \
            -d "//programme[not($DATE_FILTER)]" \
            "temp_step1.xml" > "${{ env.OUTPUT_FILE }}"
          
          # 清理临时文件
          rm -f temp_step1.xml
          
          # 验证输出文件
          if [ ! -s "${{ env.OUTPUT_FILE }}" ]; then
            echo "错误：生成输出文件失败"
            exit 1
          fi
          
          # 统计信息
          TOTAL_COUNT=$(xmlstarlet sel -t -v "count(//programme)" "${{ env.OUTPUT_FILE }}")
          echo "=========================================="
          echo "筛选后的节目总数：$TOTAL_COUNT"
          echo "------------------------------------------"
          echo "各日期节目数量统计："
          echo "------------------------------------------"
          
          for i in $(seq 0 $((env.DATE_RANGE_DAYS - 1))); do
            DATE=$(date -d "$START_DATE +${i} days" +'%Y%m%d')
            FORMATTED_DATE=$(date -d "$DATE" +'%Y-%m-%d')
            COUNT=$(xmlstarlet sel -t -v "count(//programme[contains(@start, '$DATE')])" "${{ env.OUTPUT_FILE }}")
            printf "  %s：%5d 个节目\n" "$FORMATTED_DATE" "$COUNT"
          done
          
          echo "=========================================="
          
          # 验证tv标签属性
          TV_INFO=$(xmlstarlet sel -t -m "//tv" -v "@generator-info-name" -o "，" -v "@date" -n "${{ env.OUTPUT_FILE }}")
          echo "TV元数据：$TV_INFO"

      - name: 压缩输出文件
        run: |
          echo "正在压缩文件..."
          
          # 创建压缩文件
          gzip -c "${{ env.OUTPUT_FILE }}" > "${{ env.COMPRESSED_FILE }}"
          
          # 验证压缩文件
          if [ ! -s "${{ env.COMPRESSED_FILE }}" ]; then
            echo "错误：创建压缩文件失败"
            exit 1
          fi
          
          # 显示文件信息
          ORIGINAL_SIZE=$(du -h ${{ env.OUTPUT_FILE }} | cut -f1)
          COMPRESSED_SIZE=$(du -h ${{ env.COMPRESSED_FILE }} | cut -f1)
          COMPRESSION_RATIO=$(gzip -l ${{ env.COMPRESSED_FILE }} | awk 'NR==2 {printf "%.1f%%", $2/$1*100}')
          
          echo "原始文件大小：$ORIGINAL_SIZE"
          echo "压缩文件大小：$COMPRESSED_SIZE"
          echo "压缩率：$COMPRESSION_RATIO"

      - name: 整理输出文件
        run: |
          # 创建输出目录
          mkdir -p "${{ env.OUTPUT_DIR }}"
          
          # 复制文件到输出目录
          cp -v "${{ env.OUTPUT_FILE }}" "${{ env.OUTPUT_DIR }}/"
          cp -v "${{ env.COMPRESSED_FILE }}" "${{ env.OUTPUT_DIR }}/"
          
          # 验证文件
          if [ ! -f "${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}" ] || \
             [ ! -f "${{ env.OUTPUT_DIR }}/${{ env.COMPRESSED_FILE }}" ]; then
            echo "错误：文件未正确复制到 ${{ env.OUTPUT_DIR }} 目录"
            exit 1
          fi
          
          echo "文件已整理到 ${{ env.OUTPUT_DIR }} 目录"

      - name: 提交并推送更改
        run: |
          # 配置git用户
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # 添加文件
          git add "${{ env.OUTPUT_DIR }}/"
          
          # 检查是否有更改
          if git diff --staged --quiet; then
            echo "没有需要提交的更改"
          else
            # 提交更改
            COMMIT_MSG="更新EPG [$(date +'%Y-%m-%d %H:%M:%S')]"
            git commit -m "$COMMIT_MSG"
            
            # 推送到远程
            git push origin HEAD:${GITHUB_REF#refs/heads/}
            echo "更改已提交并推送：$COMMIT_MSG"
          fi

      - name: 更新latest标签
        run: |
          TAG_NAME="latest"
          TAG_MSG="最新EPG版本 [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          # 删除本地标签（如果存在）
          if git tag -l | grep -q "^$TAG_NAME$"; then
            git tag -d "$TAG_NAME"
            echo "已删除本地标签：$TAG_NAME"
          fi
          
          # 删除远程标签（如果存在）
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            git push --delete origin "$TAG_NAME"
            echo "已删除远程标签：$TAG_NAME"
          fi
          
          # 创建新标签
          git tag -a "$TAG_NAME" -m "$TAG_MSG"
          
          # 推送标签
          git push origin "$TAG_NAME"
          
          echo "已创建并推送标签：$TAG_NAME"
          echo "标签信息：$TAG_MSG"

      - name: 创建/更新GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "EPG 最新版本"
          body: |
            ## EPG 电子节目指南 - 最新版本
            
            **更新时间**：$(date +'%Y-%m-%d %H:%M:%S')（北京时间）
            
            **包含日期范围**：$(date -d "-${{ env.DAYS_BEFORE }} days" +'%Y-%m-%d') 至 $(date -d "+1 day" +'%Y-%m-%d')
            
            **文件列表**：
            - `t.xml` - XML格式原始文件
            - `t.xml.gz` - Gzip压缩格式文件
            
            **节目数量**：$(xmlstarlet sel -t -v "count(//programme)" ${{ env.OUTPUT_FILE }} 2>/dev/null || echo "获取失败")
            
            **各日期节目统计**：
            $(for i in $(seq 0 $((env.DATE_RANGE_DAYS - 1))); do
              DATE=$(date -d "-${{ env.DAYS_BEFORE }} days +${i} days" +'%Y-%m-%d')
              COUNT=$(xmlstarlet sel -t -v "count(//programme[contains(@start, '$(date -d "$DATE" +'%Y%m%d')')])" ${{ env.OUTPUT_FILE }} 2>/dev/null || echo "0")
              echo "- $DATE：$COUNT 个节目"
            done)
            
            **文件大小**：
            - XML文件：$(du -h ${{ env.OUTPUT_FILE }} | cut -f1)
            - 压缩文件：$(du -h ${{ env.COMPRESSED_FILE }} | cut -f1)
            
            ---
            *此Release由GitHub Actions自动更新*
          files: |
            ${{ env.OUTPUT_DIR }}/${{ env.OUTPUT_FILE }}
            ${{ env.OUTPUT_DIR }}/${{ env.COMPRESSED_FILE }}
          overwrite: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
